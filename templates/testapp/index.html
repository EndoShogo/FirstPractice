<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>Apple News Reader</title>
    <!-- Import new Glass UI CSS -->
    <!-- Import new Glass UI CSS with cache busting -->
    <link rel="stylesheet" href="{{ url_for('static', filename='glassUI.css') }}?v=1.2">
    <!-- Inline minimal fallback/overrides just in case, but relying on glassUI.css -->
    <style>
        /* Fallback if static file not served immediately (dev env) */
        @import url('https://rsms.me/inter/inter.css');

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }

        /* CRITICAL: Force interactive elements to be clickable regardless of external CSS cache */
        .glass-button,
        .lang-option,
        .search-button,
        .sidebar-icon,
        .user-avatar,
        .modal-close,
        .btn-primary,
        .btn-secondary {
            pointer-events: auto !important;
            cursor: pointer !important;
            position: relative;
            z-index: 100 !important;
            /* High enough to be above any glass layers */
        }

        .action-area,
        .search-area,
        .logo-area,
        .lang-toggle {
            position: relative;
            z-index: 50 !important;
            pointer-events: auto !important;
        }

        /* Ensure modal overlay is above everything when active */
        .modal-overlay {
            z-index: 9999 !important;
        }

        .modal-content {
            z-index: 10000 !important;
        }

        /* FORCE SEARCH BUTTON POSITION (Override all external CSS/Cache) */
        .search-wrapper {
            height: 44px !important;
            display: flex !important;
            align-items: center !important;
            position: relative !important;
        }

        .search-button {
            position: absolute !important;
            top: 50% !important;
            transform: translateY(-50%) !important;
            right: 4px !important;
            margin: 0 !important;
            height: 36px !important;
            width: auto !important;
            padding: 0 16px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            z-index: 101 !important;
            pointer-events: auto !important;
            background: transparent !important;
            border: none !important;
        }
    </style>

    <!-- SVG Filter for Liquid Glass Distortion -->
    <svg style="position: absolute; width: 0; height: 0;">
        <defs>
            <filter id="glass-distortion">
                <feTurbulence type="fractalNoise" baseFrequency="0.015" numOctaves="3" result="noise" />
                <feDisplacementMap in="SourceGraphic" in2="noise" scale="8" xChannelSelector="R" yChannelSelector="G" />
            </filter>
        </defs>
    </svg>
</head>

<body>

    <!-- SIDEBAR (Liquid Glass Wrapper) -->
    <nav class="sidebar liquidGlass-wrapper">
        <div class="liquidGlass-effect"></div>
        <div class="liquidGlass-tint"></div>
        <div class="liquidGlass-shine"></div>

        <div class="liquidGlass-text"
            style="display: flex; flex-direction: column; align-items: center; width: 100%; height: 100%; padding: 20px 0; position: relative; z-index: 3;">
            <!-- Top Spacer -->
            <div style="height: 20px;"></div>

            <!-- Navigation Icons -->
            <a href="#" class="sidebar-icon" title="„Éõ„Éº„É†" onclick="event.preventDefault(); navigateHome();">
                <span class="sidebar-icon-symbol">‚åÇ</span>
                <span class="sidebar-icon-text" id="sidebar-home">„Éõ„Éº„É†</span>
            </a>
            <a href="#" class="sidebar-icon" title="„ÅäÊ∞ó„Å´ÂÖ•„Çä" onclick="event.preventDefault(); navigateFavorites();">
                <span class="sidebar-icon-symbol">‚òÜ</span>
                <span class="sidebar-icon-text" id="sidebar-favorites">„ÅäÊ∞ó„Å´ÂÖ•„Çä</span>
            </a>
            <a href="#" class="sidebar-icon" title="Ë®≠ÂÆö" onclick="event.preventDefault(); navigateSettings();">
                <span class="sidebar-icon-symbol">‚öô</span>
                <span class="sidebar-icon-text" id="sidebar-settings">Ë®≠ÂÆö</span>
            </a>

            <!-- Spacer to push user to bottom -->
            <div class="sidebar-spacer"></div>

            <!-- User Profile with Dropdown -->
            <div class="sidebar-user" id="sidebarUser">
                <div class="user-avatar" id="userAvatar" onclick="event.stopPropagation(); toggleUserMenu();">‚óè</div>
                <!-- Dropdown Menu (also with liquid glass) -->
                <div class="user-menu liquidGlass-wrapper" id="userMenu">
                    <div class="liquidGlass-effect"></div>
                    <div class="liquidGlass-tint"></div>
                    <div class="liquidGlass-shine"></div>
                    <div class="liquidGlass-text" style="display: flex; flex-direction: column;">
                        <!-- Shown when logged in -->
                        <div id="menu-logged-in" style="display: none;">
                            <a href="#" class="menu-item" id="menu-profile"
                                onclick="event.preventDefault(); openProfileModal();">Profile Settings</a>
                            <a href="#" class="menu-item" id="menu-prefs">Preferences</a>
                            <div style="height: 1px; background: rgba(0,0,0,0.1); margin: 4px 0;"></div>
                            <a href="#" class="menu-item" style="color: #ff3b30;" id="menu-logout"
                                onclick="event.preventDefault(); handleLogout();">Log Out</a>
                        </div>
                        <!-- Shown when logged out -->
                        <div id="menu-logged-out">
                            <a href="#" class="menu-item" id="menu-login"
                                onclick="event.preventDefault(); openAuthModal('login');">Login</a>
                            <a href="#" class="menu-item" id="menu-register"
                                onclick="event.preventDefault(); openAuthModal('register');">Register</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- CONTENT WRAPPER -->
    <div class="content-wrapper">

        <!-- LIQUID TOP BAR (Liquid Glass Wrapper) -->
        <header class="liquid-top-bar liquidGlass-wrapper">
            <div class="liquidGlass-effect"></div>
            <div class="liquidGlass-tint"></div>
            <div class="liquidGlass-shine"></div>

            <div class="logo-area liquidGlass-text">
                <img src="{{ url_for('static', filename='logo.png') }}" alt="News App Logo" style="height: 50px;">
            </div>

            <!-- Search Bar -->
            <div class="search-area liquidGlass-text" style="flex: 1; max-width: 600px; margin: 0 20px;">
                <div class="search-wrapper">
                    <input type="text" id="search-input" class="search-input" placeholder="Ë®ò‰∫ã„ÇíÊ§úÁ¥¢..." />
                    <button id="clear-search" class="clear-search-btn" style="display: none;">‚úï</button>
                    <button id="search-button" class="search-button liquidGlass-wrapper">
                        <div class="liquidGlass-effect"></div>
                        <div class="liquidGlass-tint"></div>
                        <div class="liquidGlass-shine"></div>
                        <span class="liquidGlass-text" id="search-btn-text">Ê§úÁ¥¢</span>
                    </button>
                </div>
            </div>

            <div class="action-area" style="display: flex; align-items: center; gap: 12px;">
                <!-- Language Toggle -->
                <div class="lang-toggle">
                    <button class="lang-option active" data-lang="ja" onclick="setLanguage('ja')">
                        üáØüáµ JA
                    </button>
                    <button class="lang-option" data-lang="en" onclick="setLanguage('en')">
                        üá∫üá∏ EN
                    </button>
                </div>

                <!-- Create Post Button (Same style as Update button) -->
                <button class="glass-button liquidGlass-wrapper" onclick="openCreatePostModal()">
                    <div class="liquidGlass-effect"></div>
                    <div class="liquidGlass-tint"></div>
                    <div class="liquidGlass-shine"></div>
                    <span class="liquidGlass-text" id="create-post-text">‚ûï ÊäïÁ®ø„Çí‰ΩúÊàê</span>
                </button>

                <!-- Update News API Button -->
                <button id="api-update-btn" class="glass-button liquidGlass-wrapper">
                    <div class="liquidGlass-effect"></div>
                    <div class="liquidGlass-tint"></div>
                    <div class="liquidGlass-shine"></div>
                    <span class="liquidGlass-text" id="update-btn-text">„Éã„É•„Éº„Çπ„ÇíÊõ¥Êñ∞</span>
                </button>
            </div>
        </header>

        <!-- MAIN CONTENT (Articles) -->
        <div class="container" id="articles-container" style="margin-top: 100px;">
            {% if articles %}
            <div class="articles-grid">
                {% for article in articles %}
                <div class="article-card liquidGlass-wrapper">
                    <div class="liquidGlass-effect"></div>
                    <div class="liquidGlass-tint"></div>
                    <div class="liquidGlass-shine"></div>

                    <div class="liquidGlass-text" style="width: 100%; position: relative; z-index: 3;">
                        <div class="article-header">
                            {% if article.urlToImage %}
                            <img src="{{ article.urlToImage }}" alt="{{ article.title_ja }}" class="article-image"
                                onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                            <div class="article-image-placeholder" style="display: none;">No Image</div>
                            {% else %}
                            <div class="article-image-placeholder">No Image</div>
                            {% endif %}

                            <div class="article-content">
                                <h2 class="article-title-ja">{{ article.title_ja }}</h2>
                                {% if article.description_ja %}
                                <p class="article-description-ja">{{ article.description_ja }}</p>
                                {% endif %}
                            </div>
                        </div>

                        <div class="article-meta">
                            {% if article.source %}
                            <span>{{ article.source }}</span>
                            {% endif %}
                            {% if article.url %}
                            <a href="{{ article.url }}" target="_blank" class="article-link">Read More</a>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="no-articles">
                <!-- Fallback content if no articles loaded -->
                <p>Welcome. Click "Update News API" to fetch the latest stories.</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- CREATE POST MODAL -->
    <div class="modal-overlay" id="createPostModal">
        <div class="modal-content liquidGlass-wrapper">
            <div class="liquidGlass-effect"></div>
            <div class="liquidGlass-tint"></div>
            <div class="liquidGlass-shine"></div>

            <div style="position: relative; z-index: 3;">
                <div class="modal-header">
                    <h2 class="modal-title" id="modal-title">ÊäïÁ®ø„Çí‰ΩúÊàê</h2>
                    <button class="modal-close" onclick="closeCreatePostModal()">‚úï</button>
                </div>

                <form id="createPostForm" class="modal-form" enctype="multipart/form-data">
                    <div class="form-group">
                        <label class="form-label" id="label-title">„Çø„Ç§„Éà„É´</label>
                        <input type="text" class="form-input" id="post-title" name="title" required
                            placeholder="„Çø„Ç§„Éà„É´„ÇíÂÖ•Âäõ...">
                    </div>

                    <div class="form-group">
                        <label class="form-label" id="label-description">Ë™¨Êòé</label>
                        <textarea class="form-textarea" id="post-description" name="description"
                            placeholder="Ë™¨Êòé„ÇíÂÖ•Âäõ..."></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label" id="label-image">ÁîªÂÉè</label>
                        <div class="file-upload-wrapper">
                            <label for="post-image" class="file-upload-label">
                                <span>üìÅ</span>
                                <span class="file-upload-text" id="upload-text">ÁîªÂÉè„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ</span>
                            </label>
                            <input type="file" class="file-upload-input" id="post-image" name="image" accept="image/*"
                                onchange="previewImage(event)">
                            <img id="image-preview" class="file-preview" style="display: none;">
                        </div>
                    </div>

                    <div class="modal-actions">
                        <button type="button" class="btn-secondary" onclick="closeCreatePostModal()"
                            id="cancel-btn">„Ç≠„É£„É≥„Çª„É´</button>
                        <button type="submit" class="btn-primary" id="submit-btn">ÊäïÁ®ø„Åô„Çã</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- AUTHENTICATION MODAL (Login/Register) -->
    <div class="modal-overlay" id="authModal">
        <div class="modal-content liquidGlass-wrapper">
            <div class="liquidGlass-effect"></div>
            <div class="liquidGlass-tint"></div>
            <div class="liquidGlass-shine"></div>

            <div style="position: relative; z-index: 3;">
                <div class="modal-header">
                    <h2 class="modal-title" id="auth-modal-title">„É≠„Ç∞„Ç§„É≥</h2>
                    <button class="modal-close" onclick="closeAuthModal()">‚úï</button>
                </div>

                <!-- Tab Switcher -->
                <div class="auth-tabs">
                    <button class="auth-tab active" id="login-tab" onclick="switchAuthTab('login')">
                        <span id="login-tab-text">„É≠„Ç∞„Ç§„É≥</span>
                    </button>
                    <button class="auth-tab" id="register-tab" onclick="switchAuthTab('register')">
                        <span id="register-tab-text">Êñ∞Ë¶èÁôªÈå≤</span>
                    </button>
                </div>

                <!-- Login Form -->
                <form id="loginForm" class="modal-form auth-form">
                    <div class="form-group">
                        <label class="form-label" id="login-label-email">„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ</label>
                        <input type="email" class="form-input" id="login-email" name="email" required
                            placeholder="email@example.com">
                    </div>

                    <div class="form-group">
                        <label class="form-label" id="login-label-password">„Éë„Çπ„ÉØ„Éº„Éâ</label>
                        <input type="password" class="form-input" id="login-password" name="password" required
                            placeholder="„Éë„Çπ„ÉØ„Éº„Éâ">
                    </div>

                    <div class="modal-actions">
                        <button type="button" class="btn-secondary" onclick="closeAuthModal()"
                            id="login-cancel-btn">„Ç≠„É£„É≥„Çª„É´</button>
                        <button type="submit" class="btn-primary" id="login-submit-btn">„É≠„Ç∞„Ç§„É≥</button>
                    </div>
                </form>

                <!-- Register Form -->
                <form id="registerForm" class="modal-form auth-form" style="display: none;">
                    <div class="form-group">
                        <label class="form-label" id="register-label-email">„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ</label>
                        <input type="email" class="form-input" id="register-email" name="email" required
                            placeholder="email@example.com">
                    </div>

                    <div class="form-group">
                        <label class="form-label" id="register-label-password">„Éë„Çπ„ÉØ„Éº„Éâ</label>
                        <input type="password" class="form-input" id="register-password" name="password" required
                            placeholder="„Éë„Çπ„ÉØ„Éº„Éâ">
                    </div>

                    <div class="form-group">
                        <label class="form-label" id="register-label-confirm">„Éë„Çπ„ÉØ„Éº„ÉâÁ¢∫Ë™ç</label>
                        <input type="password" class="form-input" id="register-confirm" name="confirm" required
                            placeholder="„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂÜçÂÖ•Âäõ">
                    </div>

                    <div class="modal-actions">
                        <button type="button" class="btn-secondary" onclick="closeAuthModal()"
                            id="register-cancel-btn">„Ç≠„É£„É≥„Çª„É´</button>
                        <button type="submit" class="btn-primary" id="register-submit-btn">ÁôªÈå≤</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- PROFILE SETTINGS MODAL -->
    <div class="modal-overlay" id="profileModal">
        <div class="modal-content liquidGlass-wrapper">
            <div class="liquidGlass-effect"></div>
            <div class="liquidGlass-tint"></div>
            <div class="liquidGlass-shine"></div>

            <div style="position: relative; z-index: 3;">
                <div class="modal-header">
                    <h2 class="modal-title" id="profile-modal-title">„Éó„É≠„Éï„Ç£„Éº„É´Ë®≠ÂÆö</h2>
                    <button class="modal-close" onclick="closeProfileModal()">‚úï</button>
                </div>

                <form id="profileForm" class="modal-form" enctype="multipart/form-data">
                    <!-- Profile Icon -->
                    <div class="form-group">
                        <label class="form-label" id="profile-label-icon">„Éó„É≠„Éï„Ç£„Éº„É´„Ç¢„Ç§„Ç≥„É≥</label>
                        <div class="profile-icon-wrapper">
                            <img id="profile-icon-preview" class="profile-icon-large" src="" alt="Profile Icon"
                                style="display: none;">
                            <div id="profile-icon-placeholder" class="profile-icon-large">‚óè</div>
                            <label for="profile-icon-input" class="icon-upload-label">
                                <span>üì∑ Â§âÊõ¥</span>
                            </label>
                            <input type="file" id="profile-icon-input" name="icon" accept="image/*"
                                style="display: none;" onchange="previewProfileIcon(event)">
                        </div>
                    </div>

                    <!-- Email -->
                    <div class="form-group">
                        <label class="form-label" id="profile-label-email">„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ</label>
                        <input type="email" class="form-input" id="profile-email" name="email"
                            placeholder="email@example.com">
                    </div>

                    <!-- Password Change Section -->
                    <div class="form-section">
                        <h3 class="form-section-title" id="profile-password-title">„Éë„Çπ„ÉØ„Éº„ÉâÂ§âÊõ¥</h3>

                        <div class="form-group">
                            <label class="form-label" id="profile-label-current-password">ÁèæÂú®„ÅÆ„Éë„Çπ„ÉØ„Éº„Éâ</label>
                            <input type="password" class="form-input" id="profile-current-password"
                                name="current_password" placeholder="ÁèæÂú®„ÅÆ„Éë„Çπ„ÉØ„Éº„Éâ">
                        </div>

                        <div class="form-group">
                            <label class="form-label" id="profile-label-new-password">Êñ∞„Åó„ÅÑ„Éë„Çπ„ÉØ„Éº„Éâ</label>
                            <input type="password" class="form-input" id="profile-new-password" name="new_password"
                                placeholder="Êñ∞„Åó„ÅÑ„Éë„Çπ„ÉØ„Éº„Éâ">
                        </div>

                        <div class="form-group">
                            <label class="form-label" id="profile-label-confirm-password">„Éë„Çπ„ÉØ„Éº„ÉâÁ¢∫Ë™ç</label>
                            <input type="password" class="form-input" id="profile-confirm-password"
                                placeholder="Êñ∞„Åó„ÅÑ„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂÜçÂÖ•Âäõ">
                        </div>
                    </div>

                    <div class="modal-actions">
                        <button type="button" class="btn-secondary" onclick="closeProfileModal()"
                            id="profile-cancel-btn">„Ç≠„É£„É≥„Çª„É´</button>
                        <button type="submit" class="btn-primary" id="profile-submit-btn">‰øùÂ≠ò</button>
                    </div>
                </form>
            </div>
        </div>
    </div>


    <!-- Scripts -->
    <script>
        // ===== LANGUAGE MANAGEMENT =====
        let currentLang = localStorage.getItem('language') || 'ja';

        const translations = {
            ja: {
                appTitle: '„Éã„É•„Éº„Çπ„É™„Éº„ÉÄ„Éº',
                updateBtn: '„Éã„É•„Éº„Çπ„ÇíÊõ¥Êñ∞',
                createPost: '‚ûï ÊäïÁ®ø„Çí‰ΩúÊàê',
                modalTitle: 'ÊäïÁ®ø„Çí‰ΩúÊàê',
                labelTitle: '„Çø„Ç§„Éà„É´',
                labelDescription: 'Ë™¨Êòé',
                labelImage: 'ÁîªÂÉè',
                uploadText: 'ÁîªÂÉè„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ',
                cancelBtn: '„Ç≠„É£„É≥„Çª„É´',
                submitBtn: 'ÊäïÁ®ø„Åô„Çã',
                readMore: 'Á∂ö„Åç„ÇíË™≠„ÇÄ',
                noImage: 'ÁîªÂÉè„Å™„Åó',
                userPost: '„ÅÇ„Å™„Åü„ÅÆÊäïÁ®ø',
                updating: 'Êõ¥Êñ∞‰∏≠...',
                noArticles: 'Ë®ò‰∫ã„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ',
                placeholderTitle: '„Çø„Ç§„Éà„É´„ÇíÂÖ•Âäõ...',
                placeholderDesc: 'Ë™¨Êòé„ÇíÂÖ•Âäõ...',
                sidebarHome: '„Éõ„Éº„É†',
                sidebarFavorites: '„ÅäÊ∞ó„Å´ÂÖ•„Çä',
                sidebarSettings: 'Ë®≠ÂÆö',
                menuProfile: '„Éó„É≠„Éï„Ç£„Éº„É´Ë®≠ÂÆö',
                menuPrefs: 'Áí∞Â¢ÉË®≠ÂÆö',
                menuLogout: '„É≠„Ç∞„Ç¢„Ç¶„Éà',
                menuLogin: '„É≠„Ç∞„Ç§„É≥',
                menuRegister: 'Êñ∞Ë¶èÁôªÈå≤',
                searchPlaceholder: 'Ë®ò‰∫ã„ÇíÊ§úÁ¥¢...',
                searchBtn: 'Ê§úÁ¥¢',
                loginTitle: '„É≠„Ç∞„Ç§„É≥',
                registerTitle: 'Êñ∞Ë¶èÁôªÈå≤',
                loginTab: '„É≠„Ç∞„Ç§„É≥',
                registerTab: 'Êñ∞Ë¶èÁôªÈå≤',
                emailLabel: '„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ',
                passwordLabel: '„Éë„Çπ„ÉØ„Éº„Éâ',
                confirmPasswordLabel: '„Éë„Çπ„ÉØ„Éº„ÉâÁ¢∫Ë™ç',
                profileTitle: '„Éó„É≠„Éï„Ç£„Éº„É´Ë®≠ÂÆö',
                profileIcon: '„Éó„É≠„Éï„Ç£„Éº„É´„Ç¢„Ç§„Ç≥„É≥',
                profileEmail: '„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ',
                passwordChange: '„Éë„Çπ„ÉØ„Éº„ÉâÂ§âÊõ¥',
                currentPassword: 'ÁèæÂú®„ÅÆ„Éë„Çπ„ÉØ„Éº„Éâ',
                newPassword: 'Êñ∞„Åó„ÅÑ„Éë„Çπ„ÉØ„Éº„Éâ',
                confirmPassword: '„Éë„Çπ„ÉØ„Éº„ÉâÁ¢∫Ë™ç',
                saveBtn: '‰øùÂ≠ò'
            },
            en: {
                appTitle: 'News Reader',
                updateBtn: 'Update News API',
                createPost: '‚ûï Create Post',
                modalTitle: 'Create Post',
                labelTitle: 'Title',
                labelDescription: 'Description',
                labelImage: 'Image',
                uploadText: 'Upload Image',
                cancelBtn: 'Cancel',
                submitBtn: 'Submit',
                readMore: 'Read More',
                noImage: 'No Image',
                userPost: 'Your Post',
                updating: 'Updating...',
                noArticles: 'No articles found yet.',
                placeholderTitle: 'Enter title...',
                placeholderDesc: 'Enter description...',
                sidebarHome: 'Home',
                sidebarFavorites: 'Favorites',
                sidebarSettings: 'Settings',
                menuProfile: 'Profile Settings',
                menuPrefs: 'Preferences',
                menuLogout: 'Log Out',
                menuLogin: 'Login',
                menuRegister: 'Register',
                searchPlaceholder: 'Search articles...',
                searchBtn: 'Search',
                loginTitle: 'Login',
                registerTitle: 'Register',
                loginTab: 'Login',
                registerTab: 'Register',
                emailLabel: 'Email',
                passwordLabel: 'Password',
                confirmPasswordLabel: 'Confirm Password',
                profileTitle: 'Profile Settings',
                profileIcon: 'Profile Icon',
                profileEmail: 'Email',
                passwordChange: 'Change Password',
                currentPassword: 'Current Password',
                newPassword: 'New Password',
                confirmPassword: 'Confirm Password',
                saveBtn: 'Save'
            }
        };

        function setLanguage(lang) {
            currentLang = lang;
            localStorage.setItem('language', lang);

            // Update language toggle buttons
            document.querySelectorAll('.lang-option').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.lang === lang);
            });

            // Update UI text
            const t = translations[lang];
            document.getElementById('update-btn-text').textContent = t.updateBtn;
            document.getElementById('create-post-text').textContent = t.createPost;
            document.getElementById('modal-title').textContent = t.modalTitle;
            document.getElementById('label-title').textContent = t.labelTitle;
            document.getElementById('label-description').textContent = t.labelDescription;
            document.getElementById('label-image').textContent = t.labelImage;
            document.getElementById('upload-text').textContent = t.uploadText;
            document.getElementById('cancel-btn').textContent = t.cancelBtn;
            document.getElementById('submit-btn').textContent = t.submitBtn;
            document.getElementById('post-title').placeholder = t.placeholderTitle;
            document.getElementById('post-description').placeholder = t.placeholderDesc;

            // Update sidebar text
            document.getElementById('sidebar-home').textContent = t.sidebarHome;
            document.getElementById('sidebar-favorites').textContent = t.sidebarFavorites;
            document.getElementById('sidebar-settings').textContent = t.sidebarSettings;
            document.getElementById('menu-profile').textContent = t.menuProfile;
            document.getElementById('menu-prefs').textContent = t.menuPrefs;
            document.getElementById('menu-logout').textContent = t.menuLogout;

            // Update search bar
            document.getElementById('search-input').placeholder = t.searchPlaceholder;
            document.getElementById('search-btn-text').textContent = t.searchBtn;

            // Ë®ÄË™ûÂ§âÊõ¥ÊôÇ„Å´Ë®ò‰∫ã„ÇíÂÜçË™≠„ÅøËæº„ÅøÔºàÂàùÊúüÂåñÊôÇ„ÇíÈô§„ÅèÔºâ
            if (document.readyState === 'complete') {
                loadAllContent();
            }
        }

        // Initialize language on load
        setLanguage(currentLang);

        // ===== MODAL MANAGEMENT =====
        function openCreatePostModal() {
            document.getElementById('createPostModal').classList.add('active');
        }

        function closeCreatePostModal() {
            document.getElementById('createPostModal').classList.remove('active');
            document.getElementById('createPostForm').reset();
            document.getElementById('image-preview').style.display = 'none';
        }

        function previewImage(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const preview = document.getElementById('image-preview');
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        }

        // ===== NAVIGATION FUNCTIONS =====
        function navigateHome() {
            console.log('Navigate to Home');
            loadAllContent();
        }

        function navigateFavorites() {
            console.log('Navigate to Favorites');
            alert(translations[currentLang].sidebarFavorites + ' Ê©üËÉΩ„ÅØÈñãÁô∫‰∏≠„Åß„Åô');
        }

        function navigateSettings() {
            console.log('Navigate to Settings');
            alert(translations[currentLang].sidebarSettings + ' Ê©üËÉΩ„ÅØÈñãÁô∫‰∏≠„Åß„Åô');
        }

        // ===== USER MENU TOGGLE =====
        function toggleUserMenu() {
            const menu = document.getElementById('userMenu');
            menu.classList.toggle('active');

            document.addEventListener('click', function closeMenu(e) {
                if (!e.target.closest('.sidebar-user')) {
                    menu.classList.remove('active');
                    document.removeEventListener('click', closeMenu);
                }
            });
        }

        // ===== FETCH AND RENDER =====
        async function loadAllContent() {
            const container = document.getElementById('articles-container');
            const t = translations[currentLang];

            try {
                // Fetch both user posts and API articles
                const [postsResponse, articlesResponse] = await Promise.all([
                    fetch('/api/posts'),
                    fetch(`/api/update?lang=${currentLang}`)
                ]);

                const posts = await postsResponse.json();
                const articles = await articlesResponse.json();

                // Combine and render
                renderAllContent(posts, articles, container);
            } catch (error) {
                console.error('Error loading content:', error);
                container.innerHTML = `<div class="no-articles"><p>${t.noArticles}</p></div>`;
            }
        }

        function renderAllContent(posts, articles, container) {
            const t = translations[currentLang];

            if ((!posts || posts.length === 0) && (!articles || articles.length === 0)) {
                container.innerHTML = `<div class="no-articles"><p>${t.noArticles}</p></div>`;
                return;
            }

            let html = '<div class="articles-grid">';

            // Render user posts first
            posts.forEach(post => {
                html += renderUserPost(post, t);
            });

            // Then render API articles
            articles.forEach(article => {
                html += renderArticle(article, t);
            });

            html += '</div>';
            container.innerHTML = html;
        }

        function renderUserPost(post, t) {
            return `
                <div class="article-card liquidGlass-wrapper">
                    <div class="liquidGlass-effect"></div>
                    <div class="liquidGlass-tint"></div>
                    <div class="liquidGlass-shine"></div>
                    
                    <div class="liquidGlass-text" style="width: 100%; position: relative; z-index: 3;">
                        <div style="margin-bottom: 10px;">
                            <span class="user-post-badge">${t.userPost}</span>
                        </div>
                        <div class="article-header">
                            ${post.image ?
                    `<img src="${escapeHtml(post.image)}" class="article-image">` :
                    `<div class="article-image-placeholder">${t.noImage}</div>`}
                            
                            <div class="article-content">
                                <h2 class="article-title-ja">${escapeHtml(post.title)}</h2>
                                ${post.description ? `<p class="article-description-ja">${escapeHtml(post.description)}</p>` : ''}
                            </div>
                        </div>
                        <div class="article-meta">
                            <span>${new Date(post.timestamp).toLocaleString(currentLang === 'ja' ? 'ja-JP' : 'en-US')}</span>
                        </div>
                    </div>
                </div>`;
        }

        function renderArticle(article, t) {
            // Ë®ÄË™ûË®≠ÂÆö„Å´Âøú„Åò„Å¶Ë°®Á§∫„Åô„Çã„Éï„Ç£„Éº„É´„Éâ„ÇíÈÅ∏Êäû
            const title = currentLang === 'ja' ? article.title_ja : article.title_en;
            const description = currentLang === 'ja' ? article.description_ja : article.description_en;

            return `
                <div class="article-card liquidGlass-wrapper">
                    <div class="liquidGlass-effect"></div>
                    <div class="liquidGlass-tint"></div>
                    <div class="liquidGlass-shine"></div>
                    
                    <div class="liquidGlass-text" style="width: 100%; position: relative; z-index: 3;">
                        <div class="article-header">
                            ${article.urlToImage ?
                    `<img src="${escapeHtml(article.urlToImage)}" class="article-image" onerror="this.style.display='none';this.nextElementSibling.style.display='flex'">
                                 <div class="article-image-placeholder" style="display:none">${t.noImage}</div>` :
                    `<div class="article-image-placeholder">${t.noImage}</div>`}
                            
                            <div class="article-content">
                                <h2 class="article-title-ja">${escapeHtml(title)}</h2>
                                ${description ? `<p class="article-description-ja">${escapeHtml(description)}</p>` : ''}
                            </div>
                        </div>
                        <div class="article-meta">
                             ${article.source ? `<span>${escapeHtml(article.source.name || article.source)}</span>` : ''}
                             <a href="${escapeHtml(article.url)}" target="_blank" class="article-link">${t.readMore}</a>
                        </div>
                    </div>
                </div>`;
        }

        // ===== API UPDATE BUTTON =====
        document.getElementById('api-update-btn').addEventListener('click', function () {
            const button = this;
            const buttonText = button.querySelector('.liquidGlass-text');
            const t = translations[currentLang];

            button.disabled = true;
            buttonText.textContent = t.updating;
            button.style.opacity = '0.7';

            loadAllContent().finally(() => {
                button.disabled = false;
                buttonText.textContent = t.updateBtn;
                button.style.opacity = '1';
            });
        });

        // ===== CREATE POST FORM SUBMISSION =====
        document.getElementById('createPostForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const formData = new FormData(this);
            const submitBtn = document.getElementById('submit-btn');
            const t = translations[currentLang];

            submitBtn.disabled = true;
            submitBtn.textContent = t.updating;

            try {
                const response = await fetch('/api/posts', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    closeCreatePostModal();
                    await loadAllContent();
                } else {
                    const error = await response.json();
                    alert(`Error: ${error.error || 'Failed to create post'}`);
                }
            } catch (error) {
                console.error('Error creating post:', error);
                alert('Failed to create post');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = t.submitBtn;
            }
        });

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ===== AUTHENTICATION STATE =====
        let currentUser = null;

        async function checkAuthStatus() {
            try {
                const response = await fetch('/api/auth/current');
                const data = await response.json();

                if (data.logged_in) {
                    currentUser = data;
                    updateUIForLoggedIn(data);
                } else {
                    currentUser = null;
                    updateUIForLoggedOut();
                }
            } catch (error) {
                console.error('Error checking auth status:', error);
                updateUIForLoggedOut();
            }
        }

        function updateUIForLoggedIn(user) {
            // Update user avatar
            const avatar = document.getElementById('userAvatar');
            if (user.icon) {
                avatar.style.backgroundImage = `url(${user.icon})`;
                avatar.style.backgroundSize = 'cover';
                avatar.style.backgroundPosition = 'center';
                avatar.textContent = '';
            } else {
                avatar.textContent = user.email.charAt(0).toUpperCase();
            }

            // Show/hide menu options
            document.getElementById('menu-logged-in').style.display = 'block';
            document.getElementById('menu-logged-out').style.display = 'none';
        }

        function updateUIForLoggedOut() {
            // Reset avatar
            const avatar = document.getElementById('userAvatar');
            avatar.style.backgroundImage = '';
            avatar.textContent = '‚óè';

            // Show/hide menu options
            document.getElementById('menu-logged-in').style.display = 'none';
            document.getElementById('menu-logged-out').style.display = 'block';
        }

        // ===== AUTHENTICATION MODALS =====
        function openAuthModal(mode) {
            switchAuthTab(mode);
            document.getElementById('authModal').classList.add('active');
        }

        function closeAuthModal() {
            document.getElementById('authModal').classList.remove('active');
            document.getElementById('loginForm').reset();
            document.getElementById('registerForm').reset();
        }

        function switchAuthTab(mode) {
            const t = translations[currentLang];

            if (mode === 'login') {
                document.getElementById('login-tab').classList.add('active');
                document.getElementById('register-tab').classList.remove('active');
                document.getElementById('loginForm').style.display = 'block';
                document.getElementById('registerForm').style.display = 'none';
                document.getElementById('auth-modal-title').textContent = t.loginTitle;
            } else {
                document.getElementById('login-tab').classList.remove('active');
                document.getElementById('register-tab').classList.add('active');
                document.getElementById('loginForm').style.display = 'none';
                document.getElementById('registerForm').style.display = 'block';
                document.getElementById('auth-modal-title').textContent = t.registerTitle;
            }
        }

        // ===== LOGIN/REGISTER HANDLERS =====
        document.getElementById('loginForm').addEventListener('submit', async function (e) {
            e.preventDefault();
            const formData = new FormData(this);
            const submitBtn = document.getElementById('login-submit-btn');
            const t = translations[currentLang];

            submitBtn.disabled = true;
            submitBtn.textContent = t.updating;

            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (response.ok) {
                    closeAuthModal();
                    await checkAuthStatus();
                    await loadAllContent();
                } else {
                    alert(data.error || 'Login failed');
                }
            } catch (error) {
                console.error('Login error:', error);
                alert('Login failed');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = t.submitBtn;
            }
        });

        document.getElementById('registerForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const password = document.getElementById('register-password').value;
            const confirm = document.getElementById('register-confirm').value;

            if (password !== confirm) {
                alert('Passwords do not match');
                return;
            }

            const formData = new FormData(this);
            const submitBtn = document.getElementById('register-submit-btn');
            const t = translations[currentLang];

            submitBtn.disabled = true;
            submitBtn.textContent = t.updating;

            try {
                const response = await fetch('/api/auth/register', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (response.ok) {
                    closeAuthModal();
                    await checkAuthStatus();
                    await loadAllContent();
                } else {
                    alert(data.error || 'Registration failed');
                }
            } catch (error) {
                console.error('Registration error:', error);
                alert('Registration failed');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = t.submitBtn;
            }
        });

        async function handleLogout() {
            try {
                await fetch('/api/auth/logout', { method: 'POST' });
                await checkAuthStatus();
                await loadAllContent();
            } catch (error) {
                console.error('Logout error:', error);
            }
        }

        // ===== PROFILE MODAL =====
        function openProfileModal() {
            if (!currentUser) return;

            // Populate current values
            document.getElementById('profile-email').value = currentUser.email;

            if (currentUser.icon) {
                document.getElementById('profile-icon-preview').src = currentUser.icon;
                document.getElementById('profile-icon-preview').style.display = 'block';
                document.getElementById('profile-icon-placeholder').style.display = 'none';
            }

            document.getElementById('profileModal').classList.add('active');
        }

        function closeProfileModal() {
            document.getElementById('profileModal').classList.remove('active');
            document.getElementById('profileForm').reset();
            document.getElementById('profile-icon-preview').style.display = 'none';
            document.getElementById('profile-icon-placeholder').style.display = 'block';
        }

        function previewProfileIcon(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    document.getElementById('profile-icon-preview').src = e.target.result;
                    document.getElementById('profile-icon-preview').style.display = 'block';
                    document.getElementById('profile-icon-placeholder').style.display = 'none';
                };
                reader.readAsDataURL(file);
            }
        }

        document.getElementById('profileForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const newPassword = document.getElementById('profile-new-password').value;
            const confirmPassword = document.getElementById('profile-confirm-password').value;

            if (newPassword && newPassword !== confirmPassword) {
                alert('Passwords do not match');
                return;
            }

            const formData = new FormData(this);
            const submitBtn = document.getElementById('profile-submit-btn');
            const t = translations[currentLang];

            submitBtn.disabled = true;
            submitBtn.textContent = t.updating;

            try {
                const response = await fetch('/api/profile', {
                    method: 'PUT',
                    body: formData
                });

                const data = await response.json();

                if (response.ok) {
                    closeProfileModal();
                    await checkAuthStatus();
                    alert(t.saveBtn + ' ÂÆå‰∫Ü');
                } else {
                    alert(data.error || 'Update failed');
                }
            } catch (error) {
                console.error('Profile update error:', error);
                alert('Update failed');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = t.saveBtn;
            }
        });

        // ===== SEARCH FUNCTIONALITY =====
        let searchTimeout = null;
        let allPosts = [];
        let allArticles = [];

        const searchInput = document.getElementById('search-input');
        const clearSearchBtn = document.getElementById('clear-search');

        searchInput.addEventListener('input', function (e) {
            const query = e.target.value.trim();

            if (query) {
                clearSearchBtn.style.display = 'block';
            } else {
                clearSearchBtn.style.display = 'none';
            }
        });

        searchInput.addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                performSearch(e.target.value.trim());
            }
        });

        clearSearchBtn.addEventListener('click', function () {
            searchInput.value = '';
            clearSearchBtn.style.display = 'none';
            loadAllContent(); // Reload all content from API
        });

        const searchButton = document.getElementById('search-button');
        searchButton.addEventListener('click', function () {
            performSearch(searchInput.value.trim());
        });

        async function performSearch(query) {
            if (!query) {
                // „ÇØ„Ç®„É™„ÅåÁ©∫„ÅÆÂ†¥Âêà„ÅØ„ÄÅ„Éá„Éï„Ç©„É´„Éà„ÅÆ„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÇíÂÜçË™≠„ÅøËæº„Åø„Åô„Çã
                loadAllContent();
                return;
            }

            const container = document.getElementById('articles-container');
            const t = translations[currentLang];

            // Ê§úÁ¥¢‰∏≠„ÅØ„É≠„Éº„Éá„Ç£„É≥„Ç∞Ë°®Á§∫„Å™„Å©„ÇíÂá∫„Åô„Å®„Çà„ÇäË¶™Âàá
            container.innerHTML = `<div class="no-articles"><p>${t.updating}</p></div>`;

            try {
                // API„Åã„ÇâÊ§úÁ¥¢ÁµêÊûú„ÇíÂèñÂæó
                const response = await fetch(`/api/search?q=${encodeURIComponent(query)}&lang=${currentLang}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();

                // Ê§úÁ¥¢ÁµêÊûú„Çí„Ç≠„É£„ÉÉ„Ç∑„É•„Å´‰øùÂ≠òÔºàË®ÄË™ûÂàá„ÇäÊõø„ÅàÊôÇ„Å´‰ΩøÁî®Ôºâ
                allPosts = data.posts || [];
                allArticles = data.articles || [];

                renderAllContent(allPosts, allArticles, container);
            } catch (error) {
                console.error('Search error:', error);
                container.innerHTML = `<div class="no-articles"><p>${t.noArticles}</p></div>`;
            }
        }

        // ===== FETCH AND RENDER =====
        async function loadAllContent() {
            const container = document.getElementById('articles-container');
            const t = translations[currentLang];

            try {
                // Fetch both user posts and API articles
                const [postsResponse, articlesResponse] = await Promise.all([
                    fetch('/api/posts'),
                    fetch(`/api/update?lang=${currentLang}`)
                ]);

                const posts = await postsResponse.json();
                const articles = await articlesResponse.json();

                // Combine and render
                renderAllContent(posts, articles, container);
            } catch (error) {
                console.error('Error loading content:', error);
                if (container) {
                    container.innerHTML = `<div class="no-articles"><p>${t.noArticles}</p></div>`;
                }
            }
        }

        function renderAllContent(posts, articles, container) {
            const t = translations[currentLang];

            if (!container) return;

            if ((!posts || posts.length === 0) && (!articles || articles.length === 0)) {
                container.innerHTML = `<div class="no-articles"><p>${t.noArticles}</p></div>`;
                return;
            }

            let html = '<div class="articles-grid">';

            // Render user posts first
            if (posts) {
                posts.forEach(post => {
                    html += renderUserPost(post, t);
                });
            }

            // Then render API articles
            if (articles) {
                articles.forEach(article => {
                    html += renderArticle(article, t);
                });
            }

            html += '</div>';
            container.innerHTML = html;
        }

        // Initialize on page load (Wait for DOM)
        document.addEventListener('DOMContentLoaded', () => {
            console.log('App initialized');
            setLanguage(currentLang);
            checkAuthStatus().then(() => loadAllContent());
        });
    </script>
</body>

</html>